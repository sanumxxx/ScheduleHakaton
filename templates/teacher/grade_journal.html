<!-- grade_journal.html -->
{% extends "base.html" %}

{% block title %}Электронный журнал{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="my-4">Электронный журнал</h1>
        <h2>Предмет: {{ subject.name }}</h2>
        <h3>Группа: {{ group.name }}</h3>
        <table class="table table-bordered" id="grade-table">
            <thead>
                <tr>
                    <th>Студент</th>
                    {% for assignment in subject.assignments %}
                        <th>{{ assignment.title }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                    <tr>
                        <td>{{ student.first_name }} {{ student.last_name }}</td>
                        {% for assignment in subject.assignments %}
                            {% set grade = student.grades|selectattr('assignment_id', 'equalto', assignment.id)|first %}
                            <td class="grade-cell {% if grade and grade.notified %}notified{% endif %}" data-student-id="{{ student.id }}" data-assignment-id="{{ assignment.id }}">
                                {% if grade %}
                                    {{ grade.grade }}
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <button id="save-button" class="btn btn-primary">Сохранить</button>
    </div>
</div>

<div id="context-menu" class="context-menu">
    <ul>
        <li data-grade="2">2</li>
        <li data-grade="3">3</li>
        <li data-grade="4">4</li>
        <li data-grade="5">5</li>
        <li data-grade="н">н</li>
        <li data-grade="">&nbsp;</li>
    </ul>
</div>

<style>
    .context-menu {
        display: none;
        position: absolute;
        background-color: white;
        border: 1px solid #ccc;
        padding: 10px;
        z-index: 1000;
    }
    .context-menu ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
    }
    .context-menu li {
        padding: 5px;
        cursor: pointer;
    }
    .context-menu li:hover {
        background-color: #f0f0f0;
    }
    .notified {
        background-color: #d4edda;
    }
</style>

<script>
    const contextMenu = document.getElementById('context-menu');
    let currentCell = null;

    document.addEventListener('click', function(event) {
        if (!contextMenu.contains(event.target)) {
            contextMenu.style.display = 'none';
        }
    });

    document.querySelectorAll('.grade-cell').forEach(function(cell) {
        cell.addEventListener('contextmenu', function(event) {
            event.preventDefault();
            currentCell = cell;
            contextMenu.style.display = 'block';
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
        });
    });

    contextMenu.querySelectorAll('li').forEach(function(item) {
        item.addEventListener('click', function() {
            const grade = item.getAttribute('data-grade');
            const studentId = currentCell.getAttribute('data-student-id');
            const assignmentId = currentCell.getAttribute('data-assignment-id');

            // Обновление ячейки таблицы сразу после выбора оценки
            currentCell.textContent = grade;
            currentCell.classList.remove('notified');

            contextMenu.style.display = 'none';
        });
    });

    document.getElementById('save-button').addEventListener('click', function() {
        const grades = [];

        document.querySelectorAll('.grade-cell').forEach(function(cell) {
            const studentId = cell.getAttribute('data-student-id');
            const assignmentId = cell.getAttribute('data-assignment-id');
            const grade = cell.textContent.trim();

            console.log(`Student ID: ${studentId}, Assignment ID: ${assignmentId}, Grade: ${grade}`);

            grades.push({
                student_id: studentId,
                assignment_id: assignmentId,
                grade: grade
            });
        });

        fetch('/save_grades', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(grades)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка сервера');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log('Оценки успешно сохранены');
                document.querySelectorAll('.grade-cell').forEach(function(cell) {
                    cell.classList.remove('notified');
                });
                data.notified_grades.forEach(function(grade) {
                    const cell = document.querySelector(`.grade-cell[data-student-id="${grade.student_id}"][data-assignment-id="${grade.assignment_id}"]`);
                    if (cell) {
                        cell.classList.add('notified');
                    }
                });
            } else {
                console.error('Ошибка сохранения оценок:', data.error);
            }
        })
        .catch(error => {
            console.error('Ошибка при отправке данных:', error);
        });
    });
</script>
{% endblock %}